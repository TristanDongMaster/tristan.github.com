
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>ajax 页面恢复上次离开的是的历史记录</title>
    <meta name="description" content="">
    <meta name="author" content="wikieswan">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap styles -->
    <link href="/assets/themes//bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional theme -->
    <link href="/assets/themes//bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Sticky Footer -->
    <link href="/assets/themes//bootstrap/css/bs-sticky-footer.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link href="/assets/themes//css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
      <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">


    <link href="http://cdn.bootcss.com/highlight.js/8.0/styles/monokai_sublime.min.css" rel="stylesheet">  


  </head>

  <body>
    <div id="wrap">
      <nav class="navbar navbar-default" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">杜若</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="jb-navbar-collapse">
          <ul class="nav navbar-nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive">所有文章</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">分类</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">标签</a></li>
      	
      
    
  



          </ul>
          
        </div><!-- /.navbar-collapse -->
      </nav>


      <div class="container">
        
<div class="page-header">
  <h1>ajax 页面恢复上次离开的是的历史记录 </h1>
</div>

<div class="row post-full">
  <div class="col-xs-12">
    <div class="date">
      <span>05 February 2015</span>
    </div>
    <div class="content">
      
<p>对于单页面应用（spa），页面内的操作基本上都是ajax，ajax页面内操作不会导致浏览器地址栏发生变化，要ajax页面的操作状态记忆需要特殊方式。</p>

<h2 id="section">思路：把页面上操作记录都存储下来，等回到页面再根据之前存储的值恢复页面状态</h2>
<p>在存储介质上，我们可以选择前端介质，比如localstorage、cookie,或者手动维护一个js对象来存储，但是页面刷新之后变量就会丢失值，还可以选择后端存储。</p>

<p>存储介质的选择不同，但是思路都一样 —- 页面上每个操作的状态都记录下来，恢复的时候利用之前存储的状态还原即可。下面逐一分析这些介质的特点：</p>

<h3 id="localstorage">localstorage</h3>

<p>兼容！痛。作为存储介质肯定没有问题，唯一的问题是兼容性，html5特性并不完全兼容所有浏览器，如果项目不考虑兼容性，这个是可以考虑的。</p>

<h3 id="cookie">cookie</h3>
<p>太珍贵了！cookie没有兼容问题，但是cookie存储的量不大，一般不推荐。</p>

<h3 id="section-1">后端存储</h3>
<p>后端把状态缓存起来，这种模式太重了。</p>

<h3 id="locationhash">location.hash存储</h3>
<p>通常我们单页面应用不会改变url，防止页面刷新的。但是我们可以利用hash的特点来实现。
注意到浏览器的地址栏通常是</p>

<pre><code>http://xxx.com/#route1
</code></pre>

<p>改变#之后的内容不会引起浏览器行为，除非你绑定了onhashchange函数。我们的思路就是把页面操作过程都存到hash中，在浏览器地址栏里面记录这些历史操作。把页面内的操作都存到hash中，当页面跳转的时候，把这些hash带着，目的是为了跳回来的时候，把这些参数带着，这样就可以解析历史操作了。</p>

<p>为此需要准备一些基本工具—-解析和拼接url中hash的值</p>

<h3 id="section-2">#</h3>
<p>1 解析hash值的参数</p>

<pre><code>define([],function () {

    return function(){
        var hash = location.hash,
            hashArr,
            queryObj = {},
            queryArr = [];
        if(hash.indexOf('&amp;')==-1){
            return queryObj;
        }
        hashArr = hash.split('&amp;');
        hashArr.shift();
        _.each(hashArr,function(e){
            queryArr = e.split('=');
            queryObj[queryArr[0]] = queryArr[1];
        });
        return queryObj;
    };
});
</code></pre>

<p>2 拼接hash参数</p>

<pre><code>define([],function () {

    return function(queryParam){
        var paramStr = '',
            rstHref = '';
        if(queryParam=={}){
            return rstHref;
        }
        for(var i in queryParam){
            paramStr += '&amp;'+i+'='+queryParam[i];
        }
        rstHref =  paramStr;
        return rstHref;
    };
});
</code></pre>

<p>浏览器hash值类似这样</p>

<pre><code>http://127.0.0.1/center#route/price/monitor/queryDetailSummery?category=&amp;ptBrand=&amp;durativeIndex=&amp;dataDate=2015-02-05&amp;currentPage=1&amp;pageSize=10&amp;isWarn=1
</code></pre>

<p>解析后的值</p>

<pre><code>Object
	category: ""
	currentPage: 1
	dataDate: "2015-02-05"
	durativeIndex: ""
	isWarn: 1
	pageSize: 10
	ptBrand: ""
	__proto__: Object
</code></pre>

<p>其中 #route/price/monitor/queryDetailSummery? 这段代码是页面路由，与参数无关。</p>

<p>这样做也有它的劣势，当过多页面需要记住操作历史的时候，可能存在页面间参数重名的问题、浏览器内容过长的问题等。如果少量页面间跳转需要记录历史，比如列表页跳转到详情页，这样的场景还是比较适用的。</p>

    </div>

  
    <ul class="tag_box inline">
      <li><i class="glyphicon glyphicon-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#javascript-ref">
    		javascript <span>10</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="glyphicon glyphicon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#javascript-ref">javascript <span>7</span></a></li>
    
  



    </ul>
    
  
    <hr>
    <ul class="pagination">
    
      <li class="prev"><a href="/tools/2015/02/04/windows-setup-jetyll" title="Windows 安装  jekyll">&laquo; Previous</a></li>
    
      <li><a href="/archive.html">Archive</a></li>
    
      <li class="next"><a href="/tools/2015/02/05/collection" title="收藏夹">Next &raquo;</a></li>
    
    </ul>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'wikieswan'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


      </div>

    </div>


    


    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script src="/assets/themes//bootstrap/js/bootstrap.min.js"></script>
    <script src="http://cdn.bootcss.com/highlight.js/8.0/highlight.min.js"></script>  
    <script>hljs.initHighlightingOnLoad();</script>  
  </body>
</html>

