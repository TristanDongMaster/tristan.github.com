
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>SSE 简单入门</title>
    <meta name="description" content="">
    <meta name="author" content="wikieswan">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap styles -->
    <link href="/assets/themes//bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional theme -->
    <link href="/assets/themes//bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Sticky Footer -->
    <link href="/assets/themes//bootstrap/css/bs-sticky-footer.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link href="/assets/themes//css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
      <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">


    <link href="http://cdn.bootcss.com/highlight.js/8.0/styles/monokai_sublime.min.css" rel="stylesheet">  


  </head>

  <body>
    <div id="wrap">
      <nav class="navbar navbar-default" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">杜若</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="jb-navbar-collapse">
          <ul class="nav navbar-nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive">所有文章</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">分类</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">标签</a></li>
      	
      
    
  



          </ul>
          
        </div><!-- /.navbar-collapse -->
      </nav>


      <div class="container">
        
<div class="page-header">
  <h1>SSE 简单入门 </h1>
</div>

<div class="row post-full">
  <div class="col-xs-12">
    <div class="date">
      <span>28 February 2015</span>
    </div>
    <div class="content">
      
<h2 id="sse-">1 SSE 是什么</h2>

<p>SSE 是 HTML5 的 Server-Sent Events缩写，服务器端发送的事件。网页自动获取服务器端的数据更新。
之前网页获取服务器端更新的数据是需要先想服务器发送情况，确定是否有数据变更，然后获取，而SSE是服务器
一旦有数据更新就主动向网页发送数据。</p>

<p>浏览器支持</p>

<pre><code>API		Chrome 	IE 	Firefox 	Safari 	Opera				
SSE		6.0 	No 	6.0 		5.0 	1.5
</code></pre>

<h2 id="js-eventsource">2 关键js对象 EventSource</h2>

<p>EventSource接口用来管理服务器发送事件.你可以通过将EventSource对象的onmessage属性指向一个自定义方法来处理那些从服务器接受到的无类型的消息(也就是,没有event字段的消息).你还可以使用addEventListener()方法来监听其他指定了事件类型的消息.</p>

<h2 id="section">3 一个简单的例子</h2>

<p>我们用一个简单的 SSE demo来介绍SSE的使用，因为我们是前端工程师，所以服务器端我们就用node来实现(ps:其他语言也可以的，只要你愿意)。</p>

<h3 id="section-1">项目文件结构</h3>

<pre><code>SSE
	node_modules
	public
		index.html
	server.js
	package.json
</code></pre>

<h3 id="indexhtml">前端代码 index.html</h3>

<pre><code>&lt;!doctype html&gt;
&lt;html&gt;
	&lt;head&gt;
		&lt;meta charset="UTF-8"&gt;
		&lt;title&gt;SSE demo&lt;/title&gt;
	&lt;/head&gt;
	&lt;body&gt;
		&lt;pre id="x"&gt;Intializing....&lt;/pre&gt;

	&lt;script src="http://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"&gt;&lt;/script&gt;
	&lt;/body&gt;
&lt;/html&gt;

&lt;script type="text/javascript"&gt;
$(function() {
	var es = new EventSource('http://127.0.0.1:8000/sseApi');
	es.addEventListener('message',function(e){
		$('#x').html('\n'+e.data+'\n')
	},false);
})
&lt;/script&gt;
</code></pre>

<p>EventSource 的参数就是服务器端提供数据的接口，创建对象es，当有数据向服务器端发送的时候，es的onmessage会触发，在回调函数中
e 指的是服务器发送的对象，我们关心的是里面的数据对象，所以用 e.data接受数据。</p>

<h3 id="serverjs">后端代码  server.js</h3>

<pre><code>var express = require('express');
var app = express();
var http = require('http');

app.use(express.static(__dirname + '/public'));

app.get('/sseApi', function(req, res){
	res.writeHead(200,{'Content-Type':'text/event-stream'})
	var timer = setInterval(function(){
		var content = 'data:' + 
			new Date().toISOString() + '\n\n';
		var b = res.write(content);
		if(!b){
			console.log("data queued (content="+content+")");
		}
		else{
			console.log("Flushed!(content="+content+")");
		}
	},1000);
	
	res.connection.on('close',function(){
		res.end();
		clearInterval(timer);
		console.log("Aborting");
	})
});

app.listen(8000);
console.log('server start at 8000');
</code></pre>

<p>在计时器函数中，每秒向客户端发送服务器当前时间戳。需要注意的是<code>var b = res.write(content);</code>之后并没有出现<code>res.end();</code>，而是在关闭连接的时候才出现。当客户端和服务器建立连接之后，直到客户端主动断开连接，否则一直保持连接。
关闭连接的方式是用户离开当前页面，比如关闭页面、跳转到其他页面等。</p>

<p>注意1</p>

<pre><code>var content = 'data:' + new Date().toISOString() + '\n\n';
</code></pre>

<p>以<code>'\n\n'</code>结尾是SSE协议方式。</p>

<p>注意2</p>

<pre><code>res.writeHead(200,{'Content-Type':'text/event-stream'})
</code></pre>

<p>发送事件的服务器脚本必须以 <code>text/event-stream</code>作为相应头.每一条消息都以一对换行符作为结尾.</p>

<p>参考 <a href="https://developer.mozilla.org/en-US/docs/Server-sent_events/Using_server-sent_events">MDN</a>:
Sending events from the server
The server-side script that sends events needs to respond using the MIME type text/event-stream. Each notification is sent as a block of text terminated by a pair of newlines. For details on the format of the event stream, see Event stream format.</p>

<h3 id="packagejson">项目配置代码 package.json</h3>

<pre><code>{
  "name": "SSE",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"
  },
  "author": "",
  "license": "ISC",
  "devDependencies": {
    "express": "^4.12.0"
  }
}
</code></pre>

<p>当代码完成之后，在浏览器值输入 <code>http://127.0.0.1:8000/index.html</code> ，就可以发现页面的数据1s变化一次,用F12查看浏览器控制台,
可以发现有一个接口 sseApi 一直在和服务器保持连接.</p>

<p>gituhub:<a href="https://github.com/wikieswan/sse-dmeo">https://github.com/wikieswan/sse-dmeo</a></p>

    </div>

  
    <ul class="tag_box inline">
      <li><i class="glyphicon glyphicon-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#javascript-ref">
    		javascript <span>10</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="glyphicon glyphicon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#javascript-ref">javascript <span>7</span></a></li>
    
  



    </ul>
    
  
    <hr>
    <ul class="pagination">
    
      <li class="prev"><a href="/javascript/2015/02/27/global-object" title="获取全局对象 this || (0, eval)('this')">&laquo; Previous</a></li>
    
      <li><a href="/archive.html">Archive</a></li>
    
      <li class="next"><a href="/javascript/2015/02/28/try-catch" title="不要在循环中使用try catch">Next &raquo;</a></li>
    
    </ul>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'wikieswan'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


      </div>

    </div>


    


    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script src="/assets/themes//bootstrap/js/bootstrap.min.js"></script>
    <script src="http://cdn.bootcss.com/highlight.js/8.0/highlight.min.js"></script>  
    <script>hljs.initHighlightingOnLoad();</script>  
  </body>
</html>

