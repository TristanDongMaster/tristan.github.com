
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>how to use r.js to packet requirejs modules</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap styles -->
    <link href="/assets/themes//bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional theme -->
    <link href="/assets/themes//bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Sticky Footer -->
    <link href="/assets/themes//bootstrap/css/bs-sticky-footer.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link href="/assets/themes//css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
      <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">


    <link href="http://cdn.bootcss.com/highlight.js/8.0/styles/monokai_sublime.min.css" rel="stylesheet">  


  </head>

  <body>
    <div id="wrap">
      <nav class="navbar navbar-default" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">wikies.wan blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="jb-navbar-collapse">
          <ul class="nav navbar-nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive/">所有文章</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories/">分类</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages/">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags/">标签</a></li>
      	
      
    
  



          </ul>
          
        </div><!-- /.navbar-collapse -->
      </nav>


      <div class="container">
        
<div class="page-header">
  <h1>how to use r.js to packet requirejs modules </h1>
</div>

<div class="row post-full">
  <div class="col-xs-12">
    <div class="date">
      <span>23 November 2015</span>
    </div>
    <div class="content">
      
<p>这篇文章用来介绍如何用 r.js 给 requirejs 模块打包</p>

<h2 id="rjs">r.js是什么</h2>

<p>r.js 是一个requirejs 官方推荐打包工具，它的作用是把零散的 define 模块按照 requirejs 的依赖关系打包到一个js文件中，来解决上线代码请求数过多的问题。除此之外，r.js 还可以对整个项目的代码进行优化，比如对js代码ugly、对css代码压缩、加上浏览器厂商前缀等。</p>

<p>关于打包问题，目前一直有关于 webpacket 和 r.js 打包方式的争论，其实它们的争端在于是否需要把公用模块单独拿出来打包尽量使用304. webpacket的做法是把公用模块打包，这样不同页面公用的模块间会用304加载模块，整体代码量会相对减少。 r.js 是把 requirejs用到的模块都打成一个文件，不去区分是否公用，这样公用的模块就会在不同的js文件中出现，整体代码量会上去，但是整体请求数会下降。
二者都有可取之处，关键看应用场景，是看重请求数的影响还是看重下载的代码量（对应流量）。</p>

<p>这里就先介绍 r.js 的打包方式吧！</p>

<p>直接看代码的同学，<a href="https://github.com/wikieswan/rjs-demo">进入这里</a></p>

<h2 id="section">准备材料</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>require.js  
r.js
node
gulp
</code></pre>
</div>

<h2 id="section-1">项目结构</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>www/
	css/
		main.css
	js/
		app/
			index.js
		mod/
			add.js
			minus.js
		pub/	
			ten.js
	lib/
		require.js
	inde.html
build.js
gulpfile.js
package.json
r.js
</code></pre>
</div>

<p>工程目录中引入了gulp，引入gulp的目的是为了能在gulpfile中执行build指令，这个不是必须的，但是如果你项目本身就是用的gulp，把build集合到你的gulpfile中会很有用的。记住， gulpfile.js  package.json 这两个文件是非必须的。</p>

<h2 id="section-2">代码结构简介</h2>

<p>项目中index.html作为文件入口，所有的资源引用来自这里。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>//index.html

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
	<span class="nt">&lt;title&gt;</span> rjs demo <span class="nt">&lt;/title&gt;</span>
	<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">&gt;</span>
	<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"css/main.css"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
 <span class="nt">&lt;h2&gt;</span>rjs demo<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"lib/require.js"</span><span class="nt">&gt;&lt;/script&gt;</span>

<span class="c">&lt;!-- 仅仅在开发环境下使用 require.dev.config.js ，打包后删除引用 --&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"js/require.dev.config.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="c">&lt;!-- end of require.dev.config.js --&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"js/app/index.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre>
</div>

<p>js/require.dev.config.js 是配置文件，requirejs的配置入口。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>//js/require.dev.config.js
requirejs.config({
    baseUrl: './js/mod',
    urlArgs: '1.0.0',
    paths: {
        pub : '../pub'
    },
    shim: {

    }
});
</code></pre>
</div>

<p>app/ 是业务逻辑代码文件夹
mod/ pub/ 是模块代码文件夹</p>

<p>app/index.js</p>

<div class="highlighter-rouge"><pre class="highlight"><code>//app/index.js
requirejs(['add','minus','pub/ten'],function(add,minus,ten){
	var a = 1, 
		b = 2;
	var rst0 = add(a,b);
	var rst1 = minus(a,b);
	var rst2 = ten(a);	

	console.log(rst0,rst1,rst2);
});
</code></pre>
</div>

<p>可以看出来，index.js引入了 ‘add’,’minus’,’pub/ten’ 这三个文件</p>

<p>这里就不罗列这3个文件的代码了，看名字就能看出来，分别是加、减、乘以10。</p>

<p>这时候用浏览器打开，查看浏览器的http请求，可以发现类似下面的形式</p>

<div class="highlighter-rouge"><pre class="highlight"><code>index.html
main.css
require.js
require.dev.config.js
index.js
add.js?1.0.0
minus.js?1.0.0
ten.js?1.0.0
</code></pre>
</div>

<p>其中?1.0.0是在配置文件 js/require.dev.config.js 配置的版本号。</p>

<h2 id="build">开始build</h2>

<p>上面介绍了requirejs项目的情况，接下来我们就准备打包吧。</p>

<p>打包必须：r.js</p>

<p>这个文件可以去requirejs官网下载。官网提供两种方式打包，分别是命令行配置和文件配置。</p>

<p>命令行配置不利于理解，也不利于代码维护，这里我们就讲文件配置打包方式。</p>

<p>我们再项目的根目录下配置一个buil.js。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>//build.js
({
    appDir: './www',
    baseUrl: 'js/mod',
    dir: './build',
    paths: {
        'pub' : '../pub',
        'app' : '../app'
    },
    modules: [
        {
            name: 'app/index'
        }
    ],
    fileExclusionRegExp: /require.dev.config.js/,
    removeCombined: true,
    optimizeCss: 'standard'
})
</code></pre>
</div>

<p>这里讲解下这几个参数的意义；</p>

<div class="highlighter-rouge"><pre class="highlight"><code>appDir
待打包项目的根目录

baseUrl
js文件的根路径，等价于  js/require.dev.config.js 配置的 baseUrl

dir
rjs打包输出路径

paths
等价于 js/require.dev.config.js 配置的 paths 。模块（modules）的相对目录。

shim
为那些没有使用define()声名依赖关系及设置模块值的模块，配置依赖关系与“浏览器全局”出口的脚本。

fileExclusionRegExp
定义打包过滤的规则，把不需要输出的文件过滤掉。

removeCombined
是否在打包前清空上次生成的代码

optimizeCss
css代码的优化规则，RequireJS Optimizer会自动优化应用程序下的CSS文件。这个参数控制CSS最优化设置。允许的值： “none”, “standard”, “standard.keepLines”, “standard.keepComments”, “standard.keepComments.keepLines”。
</code></pre>
</div>

<p>在正确配置build.js信息之后，我们需要执行一个命令来打包</p>

<div class="highlighter-rouge"><pre class="highlight"><code>node r.js -o build.js
</code></pre>
</div>

<p>打包之后，在项目根目录下生成 build/	，build/的结构如下</p>

<div class="highlighter-rouge"><pre class="highlight"><code>css/
	main.css
js/
	app/
		index.js
lib/
	require.js
build.txt	
index.html	
</code></pre>
</div>

<p>可以看到，js/文件夹下就只有 app/index.js 了。build.txt 里面记录了rjs打包规则。</p>

<p>这时候查看 build/index.html 可以看到请求结果如下</p>

<div class="highlighter-rouge"><pre class="highlight"><code>index.html
main.css
require.js
index.js
</code></pre>
</div>

<p>其中	 main.css css代码被压缩，index.js 代码合并了所以来的模块代码。</p>

<p>可以发现，这时候 js/require.dev.config.js 这个文件就没有必要引用了。为什么呢？</p>

<p>道理是这样的，js/require.dev.config.js 这个文件存在于开发环境 （www/），当html引入了 app/index.js ，js/require.dev.config.js来告诉网页怎么根据 app/index.js 的引用去找到真实的js模块代码 。</p>

<p>当打包完成之后，所以 app/index.js 依赖的模块都被打包进去了，已经完成了代码的注入了，所以就不需要依赖 js/require.dev.config.js 来寻址其他模块了 ，所以说打包后就不再需要引入了 。</p>

<h2 id="section-3">结论</h2>

<p>可以看到，打包后请求数显著下降了，整个工程的代码也都被优化了。</p>

<h2 id="gulprjs-build">如何在gulp中执行rjs build命令</h2>

<p>rjs 的打包命令是</p>

<div class="highlighter-rouge"><pre class="highlight"><code>node r.js -o build.js
</code></pre>
</div>

<p>我们只需要在gulpfile.js执行这条语句就好了 。代码如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>var gulp = require('gulp')
var exec = require('child_process').exec;

gulp.task('rjsBuild', function(cb) {
    exec('node r.js -o build.js', function (err, stdout, stderr) {
        console.log(stdout);
        console.log(stderr);
        cb(err);
    });
    
});
</code></pre>
</div>

<p>这里解释下，如果需要在gulpfile.js 中执行任意 node 语句 ，需要引入 require(‘child_process’).exec 模块，这是node 自己的模块，不需要借助其他gulp插件。</p>

<h2 id="section-4">完</h2>


    </div>

    

    
  
    <hr>
    <ul class="pagination">
    
      <li class="prev"><a href="/2015/10/25/nginx/" title="nginx mac ">&laquo; Previous</a></li>
    
      <li><a href="">Archive</a></li>
    
      <li class="next"><a href="/2015/12/18/android-cli/" title="android cli">Next &raquo;</a></li>
    
    </ul>
    <hr>
    
  </div>
</div>


      </div>

    </div>


    


    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script src="/assets/themes//bootstrap/js/bootstrap.min.js"></script>
    <script src="http://cdn.bootcss.com/highlight.js/8.0/highlight.min.js"></script>  
    <script>hljs.initHighlightingOnLoad();</script>  
  </body>
</html>

